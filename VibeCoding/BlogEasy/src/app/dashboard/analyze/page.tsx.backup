'use client'

import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Loading } from '@/components/ui/loading'
import { Sparkles, Globe, Users, Palette, Target, ArrowRight, Check } from 'lucide-react'
import { useToast } from '@/hooks/use-toast'
import type { LandingPageAnalysis } from '@/types'

export default function AnalyzePage() {
  const [loading, setLoading] = useState(true)
  const [analysis, setAnalysis] = useState<LandingPageAnalysis | null>(null)
  const [currentStep, setCurrentStep] = useState(0)
  const router = useRouter()
  const { toast } = useToast()

  const steps = [
    { name: 'Récupération du contenu', icon: Globe },
    { name: 'Analyse de la marque', icon: Palette },
    { name: 'Identification du persona', icon: Users },
    { name: 'Extraction des USP', icon: Target },
    { name: 'Analyse SEO', icon: Sparkles },
  ]

  useEffect(() => {
    // Vérifier qu'on est côté client avant d'accéder à localStorage
    if (typeof window === 'undefined') return

    const domain = localStorage.getItem('currentDomain')
    if (!domain) {
      router.push('/dashboard')
      return
    }
    analyzeLandingPage(domain)
  }, [])

  const analyzeLandingPage = async (url: string) => {
    try {
      // Phase 1: Analyse de la landing page
      setCurrentStep(0)
      
      const landingPageResponse = await fetch('/api/analyze-landing-page', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url }),
      })

      if (!landingPageResponse.ok) throw new Error('Erreur lors de l\'analyse de la landing page')
      
      const landingPageData = await landingPageResponse.json()
      
      // Sauvegarder l'analyse de landing page dans localStorage
      if (typeof window !== 'undefined') {
        localStorage.setItem('landingPageAnalysis', JSON.stringify(landingPageData))
      }
      
      // Mettre à jour l'état avec les données de landing page
      setAnalysis(landingPageData)
      setCurrentStep(2)
      
      // Phase 2: Analyse SEO avec streaming
      setCurrentStep(4)
      const seoResponse = await fetch('/api/seo-analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain: url }),
      })

      if (!seoResponse.ok) throw new Error('Erreur lors de l\'analyse SEO')
      
      // Gérer le streaming des résultats SEO
      const reader = seoResponse.body?.getReader()
      if (!reader) throw new Error('Erreur de lecture du stream')
      
      // Fonction pour traiter les morceaux de données
      const processChunks = async () => {
        let receivedAnalysis = false
        
        while (true) {
          const { done, value } = await reader.read()
          if (done) break
          
          // Convertir le chunk en texte
          const chunk = new TextDecoder().decode(value)
          const lines = chunk.split('\n').filter(line => line.trim() !== '')
          
          for (const line of lines) {
            try {
              const data = JSON.parse(line)
              
              // Traiter les messages de statut
              if (data.type === 'status') {
                // On reste sur l'étape SEO
                // Notification optionnelle pour garder l'utilisateur informé
                toast({
                  title: 'Analyse SEO en cours',
                  description: data.message,
                })
              }
              
              // Traiter les résultats finaux
              if (data.type === 'result') {
                // Sauvegarder l'analyse SEO dans localStorage
                if (typeof window !== 'undefined') {
                  localStorage.setItem('seoAnalysis', JSON.stringify(data.data))
                }
                setLoading(false)
                receivedAnalysis = true
              }
              
              // Traiter les erreurs
              if (data.type === 'error') {
                throw new Error(data.message)
              }
            } catch (e) {
              console.error('Erreur de parsing JSON:', e)
            }
          }
        }
        
        // Si on n'a jamais reçu d'analyse complète
        if (!receivedAnalysis) {
          throw new Error('Analyse SEO incomplète')
        }
      }
      
      // Démarrer le traitement du stream
      await processChunks()

    } catch (error) {
      toast({
        title: "Erreur d'analyse",
        description: error instanceof Error ? error.message : "Impossible d'analyser la page",
        variant: "destructive",
      })
      setLoading(false)
    }
  }

  const saveAnalysisData = () => {
    console.log('[NAVIGATION DEBUG] saveAnalysisData appelé')
    
    if (!analysis) {
      console.log('[NAVIGATION DEBUG] Erreur: analysis est null')
      toast({
        title: 'Erreur',
        description: 'Analyse incomplète. Veuillez réessayer.',
        variant: 'destructive'
      })
      return false
    }
    
    try {
      // Sauvegarder dans localStorage et sessionStorage
      if (typeof window !== 'undefined') {
        const serializedData = JSON.stringify(analysis)
        console.log('[NAVIGATION DEBUG] Sauvegarde analysis dans storage')
        
        // Effacer les données existantes d'abord pour éviter les problèmes de mémoire
        localStorage.removeItem('landingPageAnalysis')
        sessionStorage.removeItem('landingPageAnalysis')
        
        // Sauvegarder les nouvelles données
        localStorage.setItem('landingPageAnalysis', serializedData)
        sessionStorage.setItem('landingPageAnalysis', serializedData)
        localStorage.setItem('navigationTest', 'true-' + Date.now()) // Indicateur pour tester le localStorage
        
        // Vérifier si les données sont bien enregistrées
        const savedData = localStorage.getItem('landingPageAnalysis')
        console.log('[NAVIGATION DEBUG] Données sauvegardées avec succès:', !!savedData)
        
        // Stocker aussi dans une variable globale pour assurer le transfert
        if (typeof window !== 'undefined') {
          // @ts-ignore - définir une propriété globale temporaire
          window.__ANALYSIS_DATA__ = analysis
        }
        
        return true
      }
      return false
    } catch (error) {
      console.error('[NAVIGATION DEBUG] Erreur lors de la sauvegarde:', error)
      toast({
        title: 'Erreur technique',
        description: 'Une erreur est survenue lors de la sauvegarde des données.',
        variant: 'destructive'
      })
      return false
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white flex items-center justify-center">
        <Card className="w-full max-w-md">
          <CardHeader className="text-center">
            <CardTitle>Analyse en cours</CardTitle>
            <CardDescription>
              Notre IA analyse votre landing page...
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {steps.map((step, index) => {
                const Icon = step.icon
                const isActive = index === currentStep
                const isComplete = index < currentStep
                
                return (
                  <div
                    key={index}
                    className={`flex items-center gap-3 p-3 rounded-lg transition-all ${
                      isActive ? 'bg-turquoise/10' : isComplete ? 'opacity-50' : 'opacity-30'
                    }`}
                  >
                    <div className={`p-2 rounded-full ${
                      isActive ? 'bg-turquoise text-white' : 'bg-gray-100'
                    }`}>
                      {isComplete ? (
                        <Check className="h-4 w-4" />
                      ) : (
                        <Icon className="h-4 w-4" />
                      )}
                    </div>
                    <span className={`text-sm ${isActive ? 'font-medium' : ''}`}>
                      {step.name}
                    </span>
                    {isActive && <Loading />}
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-white">
      {/* Navigation */}
      <nav className="border-b bg-white/80 backdrop-blur-sm sticky top-0 z-50">
        <div className="container mx-auto px-6 py-4">
          <div className="flex items-center space-x-2">
            <Sparkles className="h-6 w-6 text-turquoise" />
            <span className="text-xl font-bold">BlogEasy</span>
          </div>
        </div>
      </nav>

      {/* Results */}
      <div className="container mx-auto px-6 py-12">
        <div className="max-w-4xl mx-auto">
          <div className="text-center mb-8">
            <h1 className="text-3xl font-bold text-gray-900 mb-2">
              Analyse terminée !
            </h1>
            <p className="text-gray-600">
              Voici ce que nous avons découvert sur votre marque
            </p>
          </div>

          <div className="grid gap-6 mb-8">
            {/* Brand Identity */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Palette className="h-5 w-5 text-turquoise" />
                  Identité de marque
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  <div>
                    <span className="text-sm text-gray-600">Domaine:</span>
                    <p className="font-medium">{analysis?.domain}</p>
                  </div>
                  <div>
                    <span className="text-sm text-gray-600">Ton:</span>
                    <p className="font-medium">{analysis?.tone || 'Professionnel et accessible'}</p>
                  </div>
                  <div>
                    <span className="text-sm text-gray-600">Style:</span>
                    <p className="font-medium">{analysis?.style || 'Moderne et épuré'}</p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Target Audience */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Users className="h-5 w-5 text-turquoise" />
                  Audience cible
                </CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-gray-600">
                  {analysis?.persona || 'Entrepreneurs et professionnels du digital cherchant à optimiser leur présence en ligne'}
                </p>
              </CardContent>
            </Card>

            {/* Unique Selling Points */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Target className="h-5 w-5 text-turquoise" />
                  Points forts identifiés
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex flex-wrap gap-2">
                  {(analysis?.uniqueSellingPoints || [
                    'Génération automatique',
                    'SEO optimisé',
                    'Alignement marque',
                    'Gain de temps'
                  ]).map((usp, index) => (
                    <Badge key={index} variant="turquoise">
                      {usp}
                    </Badge>
                  ))}
                </div>
              </CardContent>
            </Card>
          </div>

          {/* SECTION NAVIGATION VERS TOPICS - Solution complètement revue */}
          <div className="mt-10">
            <div className="flex flex-col items-center gap-8">
              {/* Solution principale - Lien simple */}
              <div className="flex justify-center">
                <a 
                  href="/dashboard/topics"
                  className="inline-flex items-center justify-center gap-2 rounded-md bg-turquoise px-8 py-3 text-md font-medium text-white shadow hover:bg-turquoise/90 transition-colors"
                  onClick={(e) => {
                    e.preventDefault(); // Empêcher la navigation par défaut
                    
                    // Indiquer visuellement que le clic a fonctionné
                    const link = e.currentTarget;
                    link.innerText = 'Redirection en cours...';
                    link.style.opacity = '0.7';
                    
                    // Sauvegarder les données d'analyse
                    console.log('[NAVIGATION DEBUG] Lien cliqué, sauvegarde des données');
                    const saved = saveAnalysisData();
                    
                    if (saved) {
                      // Informer l'utilisateur
                      toast({
                        title: 'Données sauvegardées',
                        description: 'Redirection vers la page des topics...'
                      });
                      
                      // Navigation programmatique immédiate
                      window.location.href = '/dashboard/topics';
                    } else {
                      // Rétablir le texte du lien en cas d'erreur
                      setTimeout(() => {
                        link.innerText = 'Continuer vers la stratégie SEO';
                        link.style.opacity = '1';
                      }, 1000);
                    }
                  }}
                >
                  Continuer vers la stratégie SEO
                  <ArrowRight className="h-4 w-4" />
                </a>
              </div>
              
              {/* Solution alternative - Formulaire simple */}
              <div className="text-center flex flex-col items-center">
                <p className="text-sm text-gray-500 mb-3">Si le bouton ne fonctionne pas, utilisez ce bouton alternatif:</p>
                
                <form 
                  action="/dashboard/topics" 
                  method="get"
                  onSubmit={(e) => {
                    // Sauvegarder les données avant la soumission du formulaire
                    saveAnalysisData();
                  }}
                >
                  <Button 
                    type="submit"
                    variant="outline"
                    className="mt-2"
                  >
                    Accéder aux suggestions de topics
                    <ArrowRight className="h-4 w-4 ml-2" />
                  </Button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
